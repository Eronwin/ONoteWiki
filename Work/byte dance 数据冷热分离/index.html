
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="kekao">
      
      
        <link rel="canonical" href="https://eronwin.github.io/ONoteWiki/Work/byte%20dance%20%E6%95%B0%E6%8D%AE%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>数据冷热分离(bytedance) - kekao's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="kekao&#39;s Blog" class="md-header__button md-logo" aria-label="kekao's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            kekao's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              数据冷热分离(bytedance)
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../Advanced_programming_language/" class="md-tabs__link">
        Advanced Language
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../Algorithm/" class="md-tabs__link">
        Algorithm
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../Machine_Learning/" class="md-tabs__link">
        Machine_Learning
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link md-tabs__link--active">
        Work
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="kekao&#39;s Blog" class="md-nav__button md-logo" aria-label="kekao's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    kekao's Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" checked>
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../..">Home</a>
          
            <label for="__nav_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Author/" class="md-nav__link">
        Author
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../Advanced_programming_language/">Advanced Language</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Advanced Language" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Advanced Language
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Advanced_programming_language/C%2B%2B/" class="md-nav__link">
        C++
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Advanced_programming_language/Golang/" class="md-nav__link">
        Golang
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Advanced_programming_language/Python/" class="md-nav__link">
        Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" checked>
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_5">
          Html+Css+Js
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Html+Css+Js" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          Html+Css+Js
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Advanced_programming_language/Html/" class="md-nav__link">
        Html
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Advanced_programming_language/Css/" class="md-nav__link">
        Css
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Advanced_programming_language/JavaScript/" class="md-nav__link">
        JavaScript
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Advanced_programming_language/lua/" class="md-nav__link">
        Lua
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Advanced_programming_language/TypeScript/" class="md-nav__link">
        TypeScript
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../Algorithm/">Algorithm</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Algorithm" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Algorithm
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../Machine_Learning/">Machine_Learning</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Machine_Learning" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Machine_Learning
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Machine_Learning/%E4%BD%BF%E7%94%A8SWIG%20%E6%8F%90%E4%BE%9Bpython%E4%B8%8Ec%2B%2B%E9%80%9A%E4%BF%A1%20%E4%BB%A5%E5%A4%87%E5%8A%A0%E9%80%9F%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AE%97%E6%B3%95/" class="md-nav__link">
        SWIG
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Mathematical
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Mathematical" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Mathematical
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Machine_Learning/1.Intro_Math/" class="md-nav__link">
        1.Intro_Math
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Machine_Learning/2.LinearRegression/" class="md-nav__link">
        2.LinearRegression
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Machine_Learning/3.LinearClassification/" class="md-nav__link">
        3.LinearClassification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Machine_Learning/4.DimentionReduction/" class="md-nav__link">
        4.DimentionReduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Machine_Learning/5.SVM/" class="md-nav__link">
        5.SVM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Machine_Learning/6.Exponentialfamily/" class="md-nav__link">
        6.Exponentialfamily
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Work</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Work" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Work
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          数据冷热分离(bytedance)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        数据冷热分离(bytedance)
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    背景
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    方案
  </a>
  
    <nav class="md-nav" aria-label="方案">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    技术选型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    架构图
  </a>
  
    <nav class="md-nav" aria-label="架构图">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    方案分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    方案对比
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    方案选择
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    基本原则
  </a>
  
    <nav class="md-nav" aria-label="基本原则">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    数据插入唯一性：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    数据更新一致性：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    数据查询准确性：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    具体细节
  </a>
  
    <nav class="md-nav" aria-label="具体细节">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    归档表结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    归档表状态流转
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    交易及支付任务（数据归档、删除、兜底）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    交易-有归档表（查询、新增、更新）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-_1" class="md-nav__link">
    支付-无归档表（查询、新增、更新）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    总结
  </a>
  
    <nav class="md-nav" aria-label="总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    成果
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    缺点
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    背景
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    方案
  </a>
  
    <nav class="md-nav" aria-label="方案">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    技术选型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    架构图
  </a>
  
    <nav class="md-nav" aria-label="架构图">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    方案分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    方案对比
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    方案选择
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    基本原则
  </a>
  
    <nav class="md-nav" aria-label="基本原则">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    数据插入唯一性：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    数据更新一致性：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    数据查询准确性：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    具体细节
  </a>
  
    <nav class="md-nav" aria-label="具体细节">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    归档表结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    归档表状态流转
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    交易及支付任务（数据归档、删除、兜底）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    交易-有归档表（查询、新增、更新）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-_1" class="md-nav__link">
    支付-无归档表（查询、新增、更新）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    总结
  </a>
  
    <nav class="md-nav" aria-label="总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    成果
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    缺点
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>数据冷热分离(bytedance)</h1>

<h2 id="_1">背景</h2>
<hr />
<blockquote>
<p>随着财经支付业务的快速发展，考虑到未来订单量持续增长，在线存储遇到更大的挑战，需提前做好规划。目前财经支付主要业务都是使用 mysql（InnoDB）作为数据存储，因历史订单信息访问频率低并占用了大量数据库存储空间，期望将历史数据跟生产最新交易数据进行分离，当前数据库保留最近一段时间的数据作为热库，历史交易存入另一个数据库压缩存储作为冷库(rocksdb)，即数据库冷热分离。此举将会极大的节省数据库设备成本，减少因在线存储空间不足扩容导致停服不可用的时长，以下基于财经支付的统一交易系统现状做的相关案例分析仅供大家参考。</p>
</blockquote>
<h2 id="_2">方案</h2>
<h3 id="_3">技术选型</h3>
<h3 id="_4">架构图</h3>
<p><img alt="img" src="../img/Pasted%20image%2020220701162205.png" /></p>
<h4 id="_5">方案分析</h4>
<p>因业务场景比较复杂，如果按照业务场景梳理工作量将几何倍的增长，换种维度，数据库相关的操作无非就是查询、插入、更新，只要能在数据库交互层实现保证查询、插入、更新这些数据库基本操作在增加冷热分离后功能不受影响即可。财经支付代码有统一的分层规范，对数据库操作全部收敛封装至数据库交互层，因此比较好改造，不扩容的情况下，热库预计保留最近 X 天（时间可调）数据， X 天前的数据归档到冷库。
<img alt="img" src="../img/Pasted%20image%2020220701162240.png" />
<img alt="img" src="../img/Pasted%20image%2020220701162300.png" /></p>
<h4 id="_6"><strong>方案对比</strong></h4>
<ul>
<li>
<p><strong>方案一：</strong>能够彻底数据库存储压力的解决方案，但是对冷库性能要求太高，如果涉及的插入、更新、查询能够根据单号过滤时间，降低对冷库的依赖。</p>
</li>
<li>
<p><strong>方案二：</strong>适用于冷库性能较低，涉及的插入、更新、查询大部分无法根据单号过滤时间时，需要热库归档表中转过滤。</p>
</li>
<li>
<p><strong>方案三：</strong>如果系统涉及的场景比较简单，历史订单后续也无变更，可以按场景进行归档。</p>
</li>
</ul>
<h4 id="_7"><strong>方案选择</strong></h4>
<p><strong>交易：</strong>交易表负责记录商户订单与财经支付内部订单的映射、交易金额、买方和卖方等重要信息，最重要的功能是防止重复交易。但是冷库相比热库性能较低，商户订单号无固定规则，无法根据单号判断时间过滤减少冷库压力，而热库 cpu 使用率很低，热库数据库计算不是瓶颈，因此交易选用方案二。交易归档表主要意义在于减少在线交易对冷库的依赖。</p>
<p><strong>支付：</strong>支付表负责保存交易单用了什么支付方式、该支付方式需要扣多少钱、从哪里扣、扣到哪里去等信息，涉及的订单查询、更新、插入都可以根据交易单号或者支付单号进行判断时间减少对冷库的查询，因此支付选择方案一。</p>
<h3 id="_8">基本原则</h3>
<p>为了充分的保证 0 事故，0 资损，方案设计时，提出了以下基本原则，在研发、测试、代码评审时均参考以下基本原则进行层层把控，可以有效的避免生产事故的发生。</p>
<h4 id="_9"><strong>数据插入唯一性：</strong></h4>
<ul>
<li>
<p>热库归档表的所有唯一键必须跟要归档的热库表保持一致。</p>
</li>
<li>
<p>热库归档记录已存在的订单，冷库必须有相应数据，</p>
</li>
<li>
<p>冷库插入: 先 insert 冷库成功后 再 insert 热库归档表</p>
</li>
<li>
<p>冷库更新：更新冷库数据，使用同一个事务 先 delete 再 insert 冷库数据</p>
</li>
<li>
<p>热库删除：删除热库数据时使用冷库数据当 where 条件，所有热库字段（包含 ID）条件都满足后才能删除成功。</p>
</li>
</ul>
<h4 id="_10"><strong>数据更新一致性：</strong></h4>
<ul>
<li>
<p>冷库无 update 操作，所有的更新操作必须在热库进行，如果数据需要更新并且仅在冷库存在，需同步到热库后，再在热库完成更新。</p>
</li>
<li>
<p>冷库热库数据同时存在时，以热库数据为准。冷库的数据来源只有热库数据同步到冷库。</p>
</li>
<li>
<p>数据从冷库同步到热库时，操作归档表和交易表需保证在同一个是事务内完成，涉及到的查询必须使用写库。</p>
</li>
</ul>
<h4 id="_11"><strong>数据查询准确性：</strong></h4>
<ul>
<li>
<p><strong>单笔查询：</strong>查询热库数据不存在时，不存在再次查询冷库（如果单号中可以判断订单日期，可再增加一层日期过滤，减少冷库查询）</p>
</li>
<li>
<p><strong>批量查询：</strong>冷库热库数据都存在时优先返回热库数据。</p>
</li>
<li>
<p><strong>批量查询：</strong>合并冷热库数据后，需看原先查询的接口顺序是否有要求，如果对顺序有要求合并后还需排序。</p>
</li>
<li>
<p><strong>减少冷库压力：</strong>冷库性能较低，线上实时交易尽可能减少对冷库的查询和依赖（可通过交易单号中的日期或者归档表进行过滤）。</p>
</li>
<li>
<p><strong>限制天数控制：</strong>数据库交互 层天数控制 为 n，归档任务控制的天数为 m，要求 m&gt;n。例如，mode 层 有些判断订单超过 n 天的才会查询冷库，归档任务只归档 m 天前的历史数据，分开控制可以防止因调整归档天数导致数据查不到情况。</p>
</li>
</ul>
<h3 id="_12">具体细节</h3>
<h4 id="_13"><strong>归档表结构</strong></h4>
<p><img alt="img" src="../img/Pasted%20image%2020220701162331.png" /></p>
<h4 id="_14"><strong>归档表状态流转</strong></h4>
<p><img alt="img" src="../img/Pasted%20image%2020220701162434.png" />
<strong>一致性删除</strong></p>
<p>使用冷库记录的所有字段当作删除热库的 where 条件（包含自增 id）,删除热库和更新热库归档状态为冷库需在一个事物，任一失败则回滚。</p>
<h4 id="_15"><strong>交易及支付任务（数据归档、删除、兜底）</strong></h4>
<p><strong>归档任务</strong></p>
<p>查询热库订单表 X （时间可调）天前的订单，同步热库订单到冷库，插入热库归档表，归档状态为处理中，放入延迟删除 mq 消息。</p>
<p><strong>归档删除 TASK</strong></p>
<p>常驻服务 TASK 消费删除 mq 消息，rpc 调用交易支付提供的删除接口，支持本地限流能力。</p>
<p><strong>兜底任务：</strong></p>
<p><strong>主要功能：</strong>查询热库归档表中处理中修改时间超过规定时间的订单强制执行删除操作。主要用来防止 mq 异常或者日常丢失消息时，使用兜底任务可以补偿消化处理中的归档记录。</p>
<p><strong>执行逻辑</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="n">数据归档任务</span><span class="err">（</span><span class="n">每天启动一次</span><span class="err">）</span><span class="w">  </span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">for</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">   </span><span class="n">初始化查询时间范围和分页</span><span class="w">  </span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">   </span><span class="k">for</span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">        </span><span class="n">查询</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">天前交易单</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="mi">1000</span><span class="p">(</span><span class="n">索引排序</span><span class="err">，</span><span class="n">滚动时间查询</span><span class="p">)</span><span class="w">  </span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">记录存在</span><span class="w"> </span><span class="n">并且</span><span class="w"> </span><span class="n">条数</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">           </span><span class="k">for</span><span class="w"> </span><span class="n">对于每条记录</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">            </span><span class="c1">// 启用x个协程处理  </span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">            </span><span class="n">交易单幂等写入冷库</span><span class="err">（</span><span class="n">不保证最新</span><span class="err">，</span><span class="n">只保证冷库数据存在性</span><span class="err">）</span><span class="w">  </span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">            </span><span class="n">幂等写归档记录表</span><span class="err">（</span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">PROCESSING</span><span class="err">，</span><span class="n">热库数据删除时再更新为COLD</span><span class="err">，</span><span class="n">归档记录已存在HOT状态更新为PROCESSING</span><span class="w"> </span><span class="err">）</span><span class="w">  </span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">            </span><span class="n">发MQ延迟消息</span><span class="err">，</span><span class="n">X</span><span class="w"> </span><span class="n">min</span><span class="err">（</span><span class="n">可配置</span><span class="err">）</span><span class="n">后删除热库数据</span><span class="w">  </span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">            </span><span class="p">}</span><span class="w">  </span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="p">}</span><span class="w">  </span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">条数</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">            </span><span class="k">continue</span><span class="w">  </span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">        </span><span class="p">}</span><span class="w">  </span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="n">时间范围往下推进</span><span class="w">  </span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="c1">//记录不存在  </span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">结束时间超过规定时间</span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">            </span><span class="k">break</span><span class="w"> </span><span class="p">(</span><span class="n">跳出循环</span><span class="err">，</span><span class="n">任务结束</span><span class="p">)</span><span class="w">  </span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">        </span><span class="p">}</span><span class="w">  </span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">        </span><span class="n">redis记录当前查询条件</span><span class="err">，</span><span class="n">方便后续任务重跑恢复继续</span><span class="w">  </span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">       </span><span class="p">}</span><span class="w">  </span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="p">}</span><span class="w">  </span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="n">删除热库数据</span><span class="err">，</span><span class="n">消费MQ</span><span class="w">  </span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="n">消费MQ记录</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">    </span><span class="n">查询冷库</span><span class="w">  </span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">    </span><span class="n">数据一致性删除</span><span class="err">（</span><span class="n">开启事务</span><span class="w"> </span><span class="n">条件删除热库数据</span><span class="err">，</span><span class="n">更新归档记录表状态为COLD</span><span class="w"> </span><span class="n">结束事务</span><span class="err">）</span><span class="w">  </span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">    </span><span class="n">一致性删除热库失败</span><span class="err">，</span><span class="n">同步热库数据到冷库</span><span class="err">，</span><span class="n">数据一致性删除</span><span class="w">  </span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="p">}</span><span class="w">  </span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="n">兜底补偿任务</span><span class="err">（</span><span class="n">每30分钟启动一次</span><span class="err">）</span><span class="w">  </span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">    </span><span class="n">查询归档记录表中状态为PROCESSING</span><span class="err">，</span><span class="n">修改时间为X</span><span class="w"> </span><span class="o">+</span><span class="n">Y</span><span class="w"> </span><span class="n">min前的记录</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="mi">1000</span><span class="w">  </span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">不存在</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">        </span><span class="k">break</span><span class="w">  </span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">对于每条记录</span><span class="w">  </span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">        </span><span class="n">查询冷库</span><span class="w">  </span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">        </span><span class="n">数据一致性删除</span><span class="err">（</span><span class="n">开启事务</span><span class="w"> </span><span class="n">条件删除热库数据</span><span class="err">，</span><span class="n">更新归档记录表状态为COLD</span><span class="w"> </span><span class="n">结束事务</span><span class="err">）</span><span class="w">  </span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">        </span><span class="n">一致性删除热库失败</span><span class="err">，</span><span class="n">同步热库数据到冷库</span><span class="err">，</span><span class="n">数据一致性删除</span><span class="w">  </span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">    </span><span class="p">}</span><span class="w">  </span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><strong>归档任务查询时间滚动机制：</strong>时间范围第一次起始时间为固定日期（财经支付订单最早点日期），结束时间为指定日期，下次开始时间等于上次结束时间，结束时间为上次结束时间加上指定时间范围）。每次查询下一个时间窗口时 redis 保存信息，指定日期，当天任务的时间范围，分页数。</p>
<p><img alt="img" src="../img/Pasted%20image%2020220701162501.png" />
<strong>归档任务并发处理：</strong>需支持多任务分片并发处理</p>
<p><strong>提升全天归档订单量：</strong>为了不影响在线交易，全天 24 小时 区分 交易高峰、低峰、日常 三个不同时间段，归档速度不同。</p>
<h4 id="-"><strong>交易-有归档表（查询、新增、更新）</strong></h4>
<p><strong>特点:</strong> 唯一键有外部单号，订单规则随机无法根据单号判断时间，因此必须有归档表。</p>
<p><strong>查询</strong></p>
<p>逻辑在数据库交互层统一实现处理</p>
<p><img alt="img" src="../img/Pasted%20image%2020220701162519.png" />
存在以下部分情况可做特殊处理减少数据库冷库依赖。</p>
<ul>
<li>
<p>单笔查询：</p>
</li>
<li>
<p>根据外部单号查询，如果查询的 qps 较高，可以查询冷库前使用归档表进行过滤判断。</p>
</li>
<li>
<p>根据交易单号查询，如果可以根据单号判断时间，查询冷库前使用单号进行时间范围过滤。</p>
</li>
<li>
<p>批量查询：部分功能管理后台功能分页查询，对数据查询范围要求较高的增加冷库查询逻辑时，可以增加传入的查询时间范围的开始时间过滤是否需要查询冷库，针对冷库热库都存在情况时优先保留热库数据（只过滤同一分页内的相同单号数据），如果对结果有异议可使用单号单独再次查询返回最新再次确认。跟产品和运营确认能不支持的就仅查询热库。</p>
</li>
</ul>
<p><strong>更新</strong></p>
<p>逻辑在数据库交互层统一实现处理
<img alt="img" src="../img/Pasted%20image%2020220701162532.png" />
<strong>插入</strong></p>
<p>逻辑在数据库交互层统一实现处
<img alt="img" src="../img/Pasted%20image%2020220701162545.png" /></p>
<h4 id="-_1"><strong>支付-无归档表（查询、新增、更新）</strong></h4>
<p><strong>特点:</strong> 唯一键都为内部单号，现有主要查询可以根据单号判断时间，不需要归档表，可以彻底解决热库数据库存储问题。</p>
<p><strong>查询</strong></p>
<p>逻辑在数据库交互层统一实现处理</p>
<p><img alt="img" src="../img/Pasted%20image%2020220701162554.png" />
存在以下部分情况可做特殊处理减少数据库冷库依赖。</p>
<ul>
<li>单笔查询：<ul>
<li>根据支付单号查询，如果可以根据单号判断时间，查询冷库前使用单号进行时间范围过滤。</li>
</ul>
</li>
<li>
<p>批量查询：</p>
<ul>
<li>
<p>根据交易单号查询，如果可以根据单号判断时间，查询冷库前使用单号进行时间范围过滤。</p>
</li>
<li>
<p>部分功能管理后台功能分页查询，对数据查询范围要求较高的增加冷库查询逻辑时，可以增加传入的查询时间范围的开始时间过滤是否需要查询冷库，针对冷库热库都存在情况时优先保留热库数据（只过滤同一分页内的相同单号数据），如果对结果有异议可使用单号单独再次查询返回最新再次确认。跟产品和运营确认能不支持的就仅查询热库。</p>
</li>
</ul>
</li>
</ul>
<p><strong>更新</strong></p>
<p>逻辑在数据库交互层统一实现处理
<img alt="img" src="../img/Pasted%20image%2020220701162638.png" /></p>
<p><strong>插入</strong></p>
<p>逻辑在数据库交互层统一实现处
<img alt="img" src="../img/Pasted%20image%2020220701162717.png" /></p>
<h2 id="_16">总结</h2>
<ol>
<li>
<p>支付因没有归档表彻底解决了数据库存储压力问题，大大的节省了数据库存储资源。</p>
</li>
<li>
<p>交易因新增了归档表，大大延缓了热库数据库存储压力，为交易数据库又额外提供了缓冲扩容时间，为后续再次优化彻底交易解决数据库存储问题提供了充足的时间。</p>
</li>
</ol>
<h3 id="_17">成果</h3>
<ol>
<li>
<p>彻底解决了支付数据库存储压力问题，有效的缓解了交易数据库热库的存储压力。</p>
</li>
<li>
<p>数据库热库保留天数可灵活调控，可以根据后续订单量进行合理调整存储可用天数。</p>
</li>
</ol>
<h3 id="_18">缺点</h3>
<ol>
<li>
<p>交易采用方案二新增了归档表，并且归档表里的存储的全量数据，仅能减缓交易和支付数据库的存储空间紧张情况，无法彻底解决数据库存储问题。</p>
</li>
<li>
<p>交易表释放的 datafree 存储空间无法提供给归档表使用，仅能交易表使用，需要不定期释放交易表的 datafree 空间。</p>
</li>
</ol>
<p><img alt="img" src="../img/Pasted%20image%2020220701162652.png" /></p>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
                Thanks for your feedback!
              
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
                Thanks for your feedback! Help us improve this page by using our <a href="..." target="_blank" rel="noopener">feedback form</a>.
              
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: Index" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Index
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["header.autohide", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.indexes", "navigation.top", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
    
  </body>
</html>